## Cache Simulator Report

#### LRU,写分配写回,不同Cache布局

* astar.trace

  |             | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ----------- | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 8B   |          |                   |                    | 61      | 122KB           |
  | 直接映射 8B | 76.6039% | 89.3997%          | 59.0897%           | 47      | 100KB           |
  | 4-way 8B    | 76.2422% | 88.9473%          | 58.8521%           | 49      | 102KB           |
  | 8-way 8B    | 75.9712% | 88.5673%          | 58.7302%           | 50      | 106KB           |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 32B   |          |                   |                    | 59      | 29.5KB          |
  | 直接映射 32B | 90.1623% | 96.2763%          | 81.7937%           | 47      | 23.5KB          |
  | 4-way 32B    | 89.3064% | 95.0056%          | 81.5056%           | 49      | 24.5KB          |
  | 8-way 32B    | 88.95%   | 94.4876%          | 81.3705%           | 50      | 25KB            |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 64B   |          |                   |                    | 58      | 14.5KB          |
  | 直接映射 64B | 94.7319% | 97.6312%          | 90.7634%           | 47      | 11.75KB         |
  | 4-way 64B    | 93.7681% | 96.2011%          | 90.438%            | 49      | 12.25KB         |
  | 8-way 64B    | 92.6621% | 94.4221%          | 90.2533%           | 50      | 12.5KB          |

* bzip2.trace

  |             | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ----------- | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 8B   |          |                   |                    | 61      | 122KB           |
  | 直接映射 8B | 97.9385% | 98.4667%          | 96.8248%           | 47      | 100KB           |
  | 4-way 8B    | 97.7339% | 98.3549%          | 96.4246%           | 49      | 102KB           |
  | 8-way 8B    | 97.0851% | 97.6334%          | 95.9291%           | 50      | 106KB           |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 32B   |          |                   |                    | 59      | 29.5KB          |
  | 直接映射 32B | 98.6689% | 99.015%           | 97.9391%           | 47      | 23.5KB          |
  | 4-way 32B    | 98.5359% | 98.9392%          | 97.6857%           | 49      | 24.5KB          |
  | 8-way 32B    | 98.0307% | 98.2856%          | 97.4933%           | 50      | 25KB            |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 64B   |          |                   |                    | 58      | 14.5KB          |
  | 直接映射 64B | 98.4103% | 98.826%           | 97.5338%           | 47      | 11.75KB         |
  | 4-way 64B    | 98.2105% | 98.7137%          | 97.1496%           | 49      | 12.25KB         |
  | 8-way 64B    | 97.4245% | 97.6388%          | 96.9727%           | 50      | 12.5KB          |

* mcf.trace

  |             | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ----------- | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 8B   |          |                   |                    | 61      | 122KB           |
  | 直接映射 8B | 95.0554% | 98.1266%          | 91.2732%           | 47      | 100KB           |
  | 4-way 8B    | 94.5919% | 97.765%           | 90.6842%           | 49      | 102KB           |
  | 8-way 8B    | 93.0357% | 96.1339%          | 89.2202%           | 50      | 106KB           |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 32B   |          |                   |                    | 59      | 29.5KB          |
  | 直接映射 32B | 97.8032% | 99.1145%          | 96.1884%           | 47      | 23.5KB          |
  | 4-way 32B    | 97.0037% | 98.103%           | 95.65%             | 49      | 24.5KB          |
  | 8-way 32B    | 95.4574% | 96.422%           | 94.2695%           | 50      | 25KB            |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 64B   |          |                   |                    | 58      | 14.5KB          |
  | 直接映射 64B | 98.5405% | 99.3783%          | 97.5088%           | 47      | 11.75KB         |
  | 4-way 64B    | 98.0642% | 98.6348%          | 97.3615%           | 49      | 12.25KB         |
  | 8-way 64B    | 95.5257% | 95.7378%          | 95.2645%           | 50      | 12.5KB          |

* perlbench.trace

  |             | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ----------- | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 8B   |          |                   |                    | 61      | 122KB           |
  | 直接映射 8B | 96.3332% | 96.2232%          | 96.4949%           | 47      | 100KB           |
  | 4-way 8B    | 90.4482% | 91.7428%          | 88.5442%           | 49      | 102KB           |
  | 8-way 8B    | 87.4003% | 88.8569%          | 85.2582%           | 50      | 106KB           |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 32B   |          |                   |                    | 59      | 29.5KB          |
  | 直接映射 32B | 97.6862% | 97.2558%          | 98.3193%           | 47      | 23.5KB          |
  | 4-way 32B    | 93.1097% | 92.5261%          | 93.968%            | 49      | 24.5KB          |
  | 8-way 32B    | 91.1747% | 90.2649%          | 92.5127%           | 50      | 25KB            |

  |              | hit rate | hit rate for read | hit rate for write | bit tag | meta data space |
  | ------------ | -------- | ----------------- | ------------------ | ------- | --------------- |
  | 全关联 64B   |          |                   |                    | 58      | 14.5KB          |
  | 直接映射 64B | 98.106%  | 97.6007%          | 98.849%            | 47      | 14.5KB          |
  | 4-way 64B    | 95.0319% | 94.158%           | 96.3172%           | 49      | 12.25KB         |
  | 8-way 64B    | 92.0475% | 90.4768%          | 94.3575%           | 50      | 12.5KB          |

* 分析

  * 块大小到的影响

    增大块大小,命中率有明显到上升,可以看出,这部分trace地址访问频繁的局部空间较大,这也解释了为什么直接相连和全关联有更好到命中率.

    组相连虽然使用了更多到内存,但没有取得更好到命中率到效果.

    全关联和直接相连对于更大到局部地址空间访问,替换次数更少,保留了更多局部地址,命中率更高.

  * 组内块数到影响

    增大组内块数,反而降低了命中率,分析认为,更多的块数降低了cache可储存连续空间的大小,在连续空间访问较大的程序表现较差.

#### Block 8B, 8-way, 写分配写回,不同替换策略

* astar.trace

  |           | hit rate | extra space used |
  | --------- | -------- | ---------------- |
  | Random    | 76.771%  | 0                |
  | LRU       | 76.4924% | 48KB             |
  | PseudoLRU | 76.4124% | 16KB             |

* bzip2.trace

  |           | hit rate | extra space used |
  | --------- | -------- | ---------------- |
  | Random    | 98.783%  | 0                |
  | LRU       | 98.783%  | 48KB             |
  | PseudoLRU | 98.783%  | 16KB             |

* mcf.trace

  |           | hit rate | extra space used |
  | --------- | -------- | ---------------- |
  | Random    | 95.4054% | 0                |
  | LRU       | 95.0447% | 48KB             |
  | PseudoLRU | 95.0616% | 16KB             |

* perlbench.trace

  |           | hit rate | extra space used |
  | --------- | -------- | ---------------- |
  | Random    | 98.2122% | 0                |
  | LRU       | 97.955%  | 48KB             |
  | PseudoLRU | 97.6082% | 16KB             |

* 分析

  * Random的表现

    Random的效果在组内块数较为充足的情况下有着不错到效果,大部分情况不发生替换,发生替换到少数情况,对命中率到影响较小.

  * PseudoLRU与LRU的比较

    在此setting下,PseudoLRU比LRU只使用了1/3的物理空间,却有着近乎相似到命中率,PseudoLRU虽是简化的LRU,但在大多数情况下此简化并不明显影响命中率.

#### Block 8B, 8-way,LRU,不同写策略

* astar.trace

  |                | hit rate | memory writing number |
  | -------------- | -------- | --------------------- |
  | 写分配写回     | 76.4924% | 84272                 |
  | 写分配写直达   | 76.4924% | 211702                |
  | 写不分配写回   | 65.1575% | 8247                  |
  | 写不分配写直达 | 65.1575% | 211702                |

* bzip2.trace

  |                | hit rate | memory writing number |
  | -------------- | -------- | --------------------- |
  | 写分配写回     | 98.783%  | 6860                  |
  | 写分配写直达   | 98.783%  | 175170                |
  | 写不分配写回   | 91.3301% | 2153                  |
  | 写不分配写直达 | 91.3301% | 175170                |

* mcf.trace

  |                | hit rate | memory writing number |
  | -------------- | -------- | --------------------- |
  | 写分配写回     | 95.0447% | 9128                  |
  | 写分配写直达   | 93.0357% | 227518                |
  | 写不分配写回   | 88.8531% | 6086                  |
  | 写不分配写直达 | 86.8513% | 227518                |

* perlbench.trace

  |                | hit rate | memory writing number |
  | -------------- | -------- | --------------------- |
  | 写分配写回     | 97.955%  | 734                   |
  | 写分配写直达   | 97.955%  | 205389                |
  | 写不分配写回   | 95.3271% | 141                   |
  | 写不分配写直达 | 95.3271% | 205389                |
  
* 分析

  * 写分配与写不分配

    写分配由于调入了所写地址到块进入内存,提高了cache命中率.

    事实上在程序中我们也能经常看到,所写地址与近期所读地址也有很强到局部性,加入写分配策略有利于提高命中率.

  * 写回与写直达

    写回策略虽然控制更为复杂一些,但相较于写直达策略,明显减少了内存到访问次数,将有利于提高CPU运行速度

#### 实现

* 参考了https://github.com/jiangxincode/CacheSim的框架实现,但原框架为32位地址,且LRU并非堆栈实现,不能动态依据元数据申请内存
* 实现了可动态分配空间到`_bitset`,及在其基础上的移位操作(标准库里到bitset居然只能动态申请内存,不知道为什么这么涉及),相关`_bitset.h _bitset.cpp`
* 在`_bitset`的基础上实现`LRUStack`,pop和push操作均由移位实现,根据需要实现了`_bitset`的部分移位操作相关`base.h``LRUStack.cpp`
* 实现PseudoLRU算法,使用`_bitset`实现flag储存